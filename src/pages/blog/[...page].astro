---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import BlogCard from '@/components/blog/BlogCard.astro';
import Pagination from '@/components/blog/Pagination.astro';
import { SITE_CONSTANTS } from '@/lib/constants';
import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');

  if (allPosts.length === 0) {
    return [
      {
        params: { page: undefined },
        props: {
          posts: [],
          currentPage: 1,
          totalPages: 1,
          totalPosts: 0,
        },
      },
    ];
  }

  // ë‚ ì§œìˆœ ì •ë ¬
  const sortedPosts = allPosts.sort(
    (a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime(),
  );

  const postsPerPage = SITE_CONSTANTS.POSTS_PER_PAGE;
  const totalPages = Math.ceil(sortedPosts.length / postsPerPage);

  // ëª¨ë“  í˜ì´ì§€ ìƒì„±
  return Array.from({ length: totalPages }, (_, i) => {
    const pageNum = i + 1;
    const start = i * postsPerPage;
    const end = start + postsPerPage;

    return {
      params: {
        // ì²« í˜ì´ì§€ëŠ” /blog, ë‚˜ë¨¸ì§€ëŠ” /blog/2, /blog/3 ë“±
        page: pageNum === 1 ? undefined : pageNum.toString(),
      },
      props: {
        posts: sortedPosts.slice(start, end),
        currentPage: pageNum,
        totalPages,
        totalPosts: sortedPosts.length,
      },
    };
  });
}

interface Props {
  posts: CollectionEntry<'blog'>[];
  currentPage: number;
  totalPages: number;
  totalPosts: number;
}

const { posts, currentPage, totalPages, totalPosts } = Astro.props;

// Featured í¬ìŠ¤íŠ¸ (ì²« í˜ì´ì§€ì—ë§Œ í‘œì‹œ)
const featuredPost = currentPage === 1 ? posts.find((post) => post.data.featured) : null;

// Featured í¬ìŠ¤íŠ¸ë¥¼ ì œì™¸í•œ ì¼ë°˜ í¬ìŠ¤íŠ¸ë“¤
const regularPosts = featuredPost ? posts.filter((post) => post.id !== featuredPost.id) : posts;

// í˜ì´ì§€ íƒ€ì´í‹€
const pageTitle = currentPage === 1 ? 'ë¸”ë¡œê·¸' : `ë¸”ë¡œê·¸ - ${currentPage}í˜ì´ì§€`;
---

<BaseLayout title={pageTitle} description="ê°œë°œ ê´€ë ¨ ì¸ì‚¬ì´íŠ¸ì™€ ê²½í—˜ì„ ê³µìœ í•˜ëŠ” ê¸°ìˆ  ë¸”ë¡œê·¸">
  <div class="container py-16">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <header class="mb-12 text-center">
      <h1 class="mb-4 text-4xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-5xl">
        ë¸”ë¡œê·¸
      </h1>
      <p class="mb-2 text-lg text-gray-600 dark:text-gray-400">
        ì‹¤ë¬´ì—ì„œ ì–»ì€ ì¸ì‚¬ì´íŠ¸ì™€ ê°œë°œ ê²½í—˜ì„ ê³µìœ í•©ë‹ˆë‹¤
      </p>
      <p class="text-sm text-gray-500 dark:text-gray-500">
        ì´ {totalPosts}ê°œì˜ í¬ìŠ¤íŠ¸
      </p>
    </header>

    <!-- Featured í¬ìŠ¤íŠ¸ (ì²« í˜ì´ì§€ì—ë§Œ) -->
    {
      featuredPost && currentPage === 1 && (
        <section class="mb-12">
          <h2 class="mb-6 text-2xl font-bold text-gray-900 dark:text-white">âœ¨ Featured Post</h2>
          <div class="grid grid-cols-1">
            <BlogCard
              post={{
                ...featuredPost.data,
                published: featuredPost.data.published,
                tags: featuredPost.data.tags,
                featured: featuredPost.data.featured,
              }}
              featured
            />
          </div>
        </section>
      )
    }

    <!-- í¬ìŠ¤íŠ¸ ëª©ë¡ -->
    <section class="mb-16">
      {
        currentPage === 1 && featuredPost && (
          <h2 class="mb-6 text-2xl font-bold text-gray-900 dark:text-white">ğŸ“ ìµœì‹  í¬ìŠ¤íŠ¸</h2>
        )
      }

      {
        regularPosts.length > 0 ? (
          <div class="grid gap-6 md:grid-cols-2">
            {regularPosts.map((post) => (
              <BlogCard
                post={{
                  ...post.data,
                  published: post.data.published,
                  tags: post.data.tags,
                  featured: post.data.featured,
                }}
              />
            ))}
          </div>
        ) : (
          <div class="rounded-lg border border-gray-200 bg-gray-50 p-12 text-center dark:border-gray-800 dark:bg-gray-900">
            <p class="text-gray-600 dark:text-gray-400">
              {currentPage === 1
                ? 'ì•„ì§ ì‘ì„±ëœ í¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.'
                : 'ì´ í˜ì´ì§€ì— í‘œì‹œí•  í¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.'}
            </p>
          </div>
        )
      }
    </section>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    {
      totalPages > 1 && (
        <Pagination currentPage={currentPage} totalPages={totalPages} basePath="/blog" />
      )
    }
  </div>
</BaseLayout>
