---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { formatDate } from '@/lib/utils/strings';
import { getNotionClient } from '@/lib/notion/client';
import { marked } from 'marked';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.data.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { data } = post;

const client = getNotionClient();
const content = await client.getPageContent(data.id);
const htmlContent = marked(content);
---

<BaseLayout title={data.title} description={data.description} type="article">
  <article class="mx-auto max-w-3xl">
    <header class="mb-12 text-center">
      <div class="mb-4 font-mono text-sm text-gray-500 dark:text-gray-500">
        <time datetime={data.publishDate.toISOString()}>
          {formatDate(data.publishDate)}
        </time>
        {
          data.readingTime && (
            <>
              <span class="mx-2">•</span>
              <span>{data.readingTime}min read</span>
            </>
          )
        }
      </div>

      <h1
        class="mb-4 text-3xl font-bold text-gray-900 dark:text-gray-100 sm:text-4xl"
        transition:name={`post-${data.slug}`}
      >
        {data.title}
      </h1>

      {
        data.tags.length > 0 && (
          <div class="flex flex-wrap justify-center gap-2">
            {data.tags.map((tag) => (
              <span class="font-mono text-sm text-gray-500 dark:text-gray-500">#{tag}</span>
            ))}
          </div>
        )
      }
    </header>

    <div
      class="prose prose-lg max-w-none dark:prose-invert prose-headings:font-mono prose-code:text-blue-600 prose-code:before:content-[''] prose-code:after:content-[''] prose-pre:bg-gray-900 prose-pre:text-gray-100 dark:prose-code:text-blue-400"
      set:html={htmlContent}
    />

    <footer class="mt-16 border-t border-gray-200 pt-8 dark:border-gray-800">
      <a
        href="/posts"
        class="inline-flex items-center gap-2 font-mono text-sm text-blue-600 hover:underline dark:text-blue-400"
      >
        <span>←</span>
        back to list
      </a>
    </footer>
  </article>
</BaseLayout>
